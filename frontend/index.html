<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AMBI360 - Plataforma de tours virtuais 360¬∞ com gest√£o de projetos e hotspots interativos">
    <meta name="keywords" content="tour virtual, 360, panorama, gest√£o de projetos, hotspots">
    <meta name="theme-color" content="#3eb3df">
    <title>AMBI360 - Tours Virtuais 360¬∞</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="hotspots.css">
    <link rel="stylesheet" href="https://cdn.pannellum.org/2.5/pannellum.css">
</head>
<body>
    <!-- Login Container -->
    <main class="login-container" id="loginContainer">
        <section class="login-box">
            <div id="adminLogin">
                <div class="login-header">
                    <div class="logo">
                        <img src="logo-ambi360.svg" alt="AMBI360" style="width: 120px; height: 120px;">
                    </div>
                    <h2>Painel Admin</h2>
                    <p class="subtitle">Digite apenas a senha admin</p>
                </div>
                <form id="adminForm">
                    <div class="input-group">
                        <input type="password" id="adminPassword" placeholder="Digite: admin123" required>
                    </div>
                    <button type="submit" class="btn-primary w-100">Entrar como Admin</button>
                </form>
            </div>
            
            <div id="errorMessage" class="error hidden"></div>
        </section>
    </main>

    <!-- Viewer Container -->
    <section class="viewer-container hidden" id="viewerContainer">
        <aside class="nav-sidebar" id="navSidebar">
            <div class="nav-header">
                <h2 id="navProjectTitle">Projeto</h2>
                <button class="nav-close" onclick="toggleNavigation()">‚úï</button>
            </div>
            <div class="nav-content">
                <div class="nav-section">
                    <h3>Ambientes</h3>
                    <div class="nav-search">
                        <input type="text" id="navSearch" placeholder="Pesquisar pontos..." onkeyup="filterNavigation(this.value)">
                        <span class="search-icon">üîç</span>
                    </div>
                    <div class="nav-rooms" id="navRooms"></div>
                </div>
            </div>
            <div class="nav-footer">
                <button class="nav-logout" id="logoutBtn">Sair</button>
            </div>
        </aside>
        
        <div class="viewer-main">
            <header class="viewer-header">
                <div class="viewer-title-container">
                    <img id="projectLogo" class="project-logo" src="" alt="Logo do Projeto" style="display: none;">
                    <div>
                        <h1 class="viewer-title" id="projectTitle"></h1>
                        <div class="scene-breadcrumb" id="sceneBreadcrumb"></div>
                    </div>
                </div>
                <div class="viewer-controls">
                    <button class="control-btn" id="backBtn" onclick="goBackToPreviousScene()" style="display: none;">‚Üê Voltar</button>
                    <button class="control-btn" onclick="shareProject()">üîó Compartilhar</button>
                    <button class="control-btn" onclick="toggleFullscreen()">‚õ∂ Tela Cheia</button>
                    <button class="control-btn" onclick="showHelpModal()">‚ùì Ajuda</button>
                </div>
            </header>
            <div id="panorama"></div>
        </div>
    </section>

    <!-- Admin Panel -->
    <section class="admin-panel hidden" id="adminPanel">
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="sidebar-logo-btn" onclick="showSection('projects')">
                    <img src="logo-ambi-sidebar.svg" alt="AMBI360 Admin" style="width: 180px; height: 80px;">
                </button>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" onclick="showSection('projects')">
                    <span class="nav-icon">üìã</span>
                    <span>Projetos</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('create')">
                    <span class="nav-icon">‚ûï</span>
                    <span>Criar Projeto</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <button class="logout-btn" id="adminLogoutBtn">Sair</button>
            </div>
        </div>

        <div class="admin-content">
            <header class="content-header">
                <div>
                    <h1 class="page-title" id="pageTitle">Projetos</h1>
                    <p class="page-subtitle" id="pageSubtitle">Aqui voc√™ faz a gest√£o de seus projetos.</p>
                </div>
                <div class="header-actions">
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" placeholder="Pesquise por projetos aqui">
                    </div>
                    <button id="themeToggleBtn" class="btn-secondary" onclick="toggleDarkMode()">Modo Escuro</button>
                    <button class="btn-primary" onclick="showSection('create')">
                        <span>‚ûï</span>
                        Criar Projeto
                    </button>
                </div>
            </header>

            <div class="content-body">
                <!-- Projects Section -->
                <section id="projectsSection">
                    <div class="projects-header">
                        <h2 class="section-title">Todos os projetos</h2>
                        <div class="filter-buttons">
                            <div class="filter-dropdown">
                                <button class="filter-btn dropdown-btn" onclick="toggleFilterDropdown()">ADICIONAR FILTRO ‚ñº</button>
                                <div class="dropdown-menu hidden" id="filterDropdown">
                                    <button onclick="sortProjects('newest')">Do mais recente para o mais antigo</button>
                                    <button onclick="sortProjects('oldest')">Do mais antigo para o mais recente</button>
                                    <button onclick="sortProjects('alphabetical')">Em ordem alfab√©tica (A-Z)</button>
                                    <button onclick="sortProjects('alphabetical-reverse')">Em ordem alfab√©tica (Z-A)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="projects-grid" id="projectsGrid"></div>
                    
                    <div class="empty-state hidden" id="emptyState">
                        <div class="empty-icon">üìÅ</div>
                        <h3>Nenhum projeto encontrado</h3>
                        <p>Crie seu primeiro projeto usando o bot√£o acima</p>
                    </div>
                </section>

                <!-- Create Project Section -->
                <section id="createSection" class="hidden">
                    <div class="admin-section">
                        <h2>Criar Novo Projeto</h2>
                        <form id="createProjectForm">
                            <div class="form-group">
                                <label class="form-label" for="newProjectName">Nome do Projeto</label>
                                <input type="text" class="form-input" id="newProjectName" placeholder="Digite o nome do projeto" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="newProjectTitle">T√≠tulo do Projeto</label>
                                <input type="text" class="form-input" id="newProjectTitle" placeholder="Digite o t√≠tulo" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="logoUpload">Logo Personalizada (Opcional)</label>
                                <div class="file-upload" onclick="document.getElementById('logoUpload').click()">
                                    <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                                    <div id="logoUploadText">üñºÔ∏è Clique para selecionar uma logo</div>
                                    <small>Formatos suportados: JPG, PNG, SVG</small>
                                </div>
                                <div id="logoPreview" class="logo-preview hidden"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="imageUpload">Imagem 360¬∞</label>
                                <div class="file-upload" onclick="document.getElementById('imageUpload').click()">
                                    <input type="file" id="imageUpload" accept="image/*" style="display: none;" required>
                                    <div>üì∑ Clique para selecionar uma imagem 360¬∞</div>
                                    <small>Formatos suportados: JPG, PNG</small>
                                </div>
                            </div>
                            <div id="imagePreview" class="hidden">
                                <h3>Pr√©via da Imagem 360¬∞:</h3>
                                <div class="preview-controls">
                                    <button type="button" id="addHotspotBtn" class="btn-secondary">Adicionar Ponto</button>
                                    <button type="button" id="removeHotspotBtn" class="btn-danger">Remover Pontos</button>
                                </div>
                                <div class="preview-layout">
                                    <div class="preview-panorama">
                                        <div id="previewPanorama"></div>
                                    </div>
                                    <div class="preview-sidebar">
                                        <div id="hotspotsList"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <button type="submit" class="create-btn" id="submitProjectBtn">Criar Projeto</button>
                                <button type="button" class="btn-secondary" onclick="showSection('projects')">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </section>
            </div>
        </div>
    </section>

    <!-- Help Modal -->
    <div id="helpModal" class="hidden">
        <div class="modal-backdrop" onclick="closeHelpModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ajuda</h2>
                <button class="modal-close" onclick="closeHelpModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <ul>
                    <li>Mouse: arraste para rotacionar</li>
                    <li>Scroll: zoom in/out</li>
                    <li>Clique nos pontos para navegar</li>
                    <li>ESC: sair do modo tela cheia</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="closeHelpModal()">Entendi</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.pannellum.org/2.5/pannellum.js"></script>
    <script>
        const ADMIN_PASSWORD = 'admin123';
        let projects = {};
        let viewer = null;
        let previewViewer = null;
        let hotspots = [];
        let addingHotspot = false;
        let editingProjectName = null;
        let isAdminViewing = false;
        let currentParentId = null;
        let previewCurrentImage = null;
        let previewRootImage = null;

        function loadProjects() {
            const saved = localStorage.getItem('ambi360_projects');
            return saved ? JSON.parse(saved) : {};
        }

        function saveProjects() {
            localStorage.setItem('ambi360_projects', JSON.stringify(projects));
        }

        document.addEventListener('DOMContentLoaded', function() {
            projects = loadProjects();
            
            // Verificar se h√° projeto na URL
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');
            if (projectId && projects[projectId]) {
                previewProject(projectId);
                return;
            }
            
            document.getElementById('adminForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const password = document.getElementById('adminPassword').value;
                if (password === ADMIN_PASSWORD) {
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    updateProjectsGrid();
                } else {
                    document.getElementById('errorMessage').textContent = 'Senha incorreta';
                    document.getElementById('errorMessage').classList.remove('hidden');
                }
            });

            document.getElementById('createProjectForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('newProjectName').value;
                const title = document.getElementById('newProjectTitle').value;
                const file = document.getElementById('imageUpload').files[0];
                const logoFile = document.getElementById('logoUpload').files[0];
                
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const projectData = {
                            title: title,
                            image: e.target.result,
                            hotspots: [...hotspots],
                            createdAt: new Date().toISOString(),
                            logo: null
                        };
                        
                        if (logoFile) {
                            const logoReader = new FileReader();
                            logoReader.onload = function(logoEvent) {
                                projectData.logo = logoEvent.target.result;
                                projects[name] = projectData;
                                saveProjects();
                                showSection('projects');
                                updateProjectsGrid();
                                resetForm();
                            };
                            logoReader.readAsDataURL(logoFile);
                        } else {
                            projects[name] = projectData;
                            saveProjects();
                            showSection('projects');
                            updateProjectsGrid();
                            resetForm();
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('imageUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        showImagePreview(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('logoUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('logoPreview');
                        preview.innerHTML = `<img src="${e.target.result}" alt="Logo preview" style="max-width:100px;">`;
                        preview.classList.remove('hidden');
                        document.getElementById('logoUploadText').innerHTML = '‚úÖ Logo selecionada';
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('addHotspotBtn').addEventListener('click', function() {
                addingHotspot = !addingHotspot;
                this.textContent = addingHotspot ? 'Clique na imagem' : 'Adicionar Ponto';
                this.className = addingHotspot ? 'btn-primary' : 'btn-secondary';
            });

            document.getElementById('removeHotspotBtn').addEventListener('click', function() {
                hotspots = [];
                updateHotspotsList();
                if (previewViewer) {
                    previewViewer.removeAllHotSpots();
                }
            });

            document.getElementById('adminLogoutBtn').addEventListener('click', logout);
        });

        function showImagePreview(imageSrc) {
            document.getElementById('imagePreview').classList.remove('hidden');
            currentParentId = null;
            previewCurrentImage = imageSrc;
            previewRootImage = imageSrc;

            if (previewViewer) {
                previewViewer.destroy();
            }

            setTimeout(() => {
                previewViewer = pannellum.viewer('previewPanorama', {
                    type: 'equirectangular',
                    panorama: previewCurrentImage,
                    autoLoad: true,
                    showZoomCtrl: false,
                    showFullscreenCtrl: false
                });
                
                previewViewer.on('load', function() {
                    setupHotspotClick();
                    updateHotspotsList();
                });
            }, 100);
        }

        function setupHotspotClick() {
            const panoramaDiv = document.getElementById('previewPanorama');
            if (!panoramaDiv) return;
            
            panoramaDiv.addEventListener('click', function(e) {
                if (!addingHotspot) return;
                e.preventDefault();
                e.stopPropagation();
                
                let coords = null;
                try { 
                    coords = previewViewer.mouseEventToCoords(e); 
                } catch (_) {}
                
                const pitch = coords ? coords[0] : previewViewer.getPitch();
                const yaw = coords ? coords[1] : previewViewer.getYaw();
                
                const hotspot = {
                    id: 'hotspot_' + Date.now(),
                    pitch: pitch,
                    yaw: yaw,
                    text: 'Ponto ' + (hotspots.length + 1),
                    targetImage: '',
                    parentId: currentParentId,
                    type: 'normal'
                };
                
                hotspots.push(hotspot);
                addHotspotToViewer(hotspot);
                updateHotspotsList();
                addingHotspot = false;
                document.getElementById('addHotspotBtn').textContent = 'Adicionar Ponto';
                document.getElementById('addHotspotBtn').className = 'btn-secondary';
            });
        }

        function addHotspotToViewer(hotspot) {
            if (previewViewer) {
                previewViewer.addHotSpot({
                    id: hotspot.id,
                    pitch: hotspot.pitch,
                    yaw: hotspot.yaw,
                    type: 'info',
                    text: hotspot.text
                });
            }
        }

        function updateHotspotsList() {
            const list = document.getElementById('hotspotsList');
            list.innerHTML = '';

            const currentList = hotspots.filter(h => (h.parentId || null) === (currentParentId || null));

            if (currentParentId) {
                const backBtn = document.createElement('button');
                backBtn.textContent = '‚Ü© Voltar';
                backBtn.className = 'btn-secondary';
                backBtn.style.marginBottom = '8px';
                backBtn.onclick = goBackToParent;
                list.appendChild(backBtn);
            }

            currentList.forEach((hotspot, index) => {
                const item = document.createElement('div');
                item.className = 'hotspot-item';
                item.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px;">Ponto ${index + 1}</div>
                    <input type="text" placeholder="Nome do ponto" value="${hotspot.text}" onchange="updateHotspotText('${hotspot.id}', this.value)" style="width:100%;margin-bottom:8px;">
                    <input type="file" accept="image/*" onchange="updateHotspotImage('${hotspot.id}', this)" style="width: 100%; margin-bottom: 8px;">
                    <button onclick="${hotspot.targetImage ? `enterHotspot('${hotspot.id}')` : `testHotspot('${hotspot.id}')`}" style="width: 100%; margin-bottom: 8px;">
                        ${hotspot.targetImage ? 'üîç Entrar no Ponto' : 'Testar Posi√ß√£o'}
                    </button>
                    <button onclick="removeHotspot('${hotspot.id}')" style="width: 100%;">Remover</button>
                `;
                list.appendChild(item);
            });
        }

        function updateHotspotText(id, text) {
            const hotspot = hotspots.find(h => h.id === id);
            if (hotspot) {
                hotspot.text = text;
                if (previewViewer) {
                    previewViewer.removeHotSpot(id);
                    addHotspotToViewer(hotspot);
                }
            }
        }

        function updateHotspotImage(id, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const hotspot = hotspots.find(h => h.id === id);
                    if (hotspot) {
                        hotspot.targetImage = e.target.result;
                        updateHotspotsList();
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function enterHotspot(id) {
            const hotspot = hotspots.find(h => h.id === id);
            if (hotspot && hotspot.targetImage && previewViewer) {
                currentParentId = hotspot.id;
                previewCurrentImage = hotspot.targetImage;
                showImagePreview(previewCurrentImage);
                currentParentId = hotspot.id;
                updateHotspotsList();
            }
        }

        function testHotspot(id) {
            const hotspot = hotspots.find(h => h.id === id);
            if (hotspot && previewViewer) {
                previewViewer.lookAt(hotspot.pitch, hotspot.yaw, 75, 1000);
            }
        }

        function goBackToParent() {
            const parentHotspot = hotspots.find(h => h.id === currentParentId);
            const grandParentId = parentHotspot ? (parentHotspot.parentId || null) : null;
            currentParentId = grandParentId;
            
            if (grandParentId) {
                const gpHotspot = hotspots.find(h => h.id === grandParentId);
                if (gpHotspot && gpHotspot.targetImage) {
                    previewCurrentImage = gpHotspot.targetImage;
                    previewViewer.setPanorama(previewCurrentImage);
                }
            } else {
                previewCurrentImage = previewRootImage;
                showImagePreview(previewCurrentImage);
            }
            updateHotspotsList();
        }

        function removeHotspot(id) {
            hotspots = hotspots.filter(h => h.id !== id);
            if (previewViewer) {
                previewViewer.removeHotSpot(id);
            }
            updateHotspotsList();
        }

        function updateProjectsGrid() {
            const grid = document.getElementById('projectsGrid');
            const emptyState = document.getElementById('emptyState');
            grid.innerHTML = '';
            
            const projectEntries = Object.entries(projects);
            
            if (projectEntries.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            projectEntries.forEach(([name, project]) => {
                const card = createProjectCard(name, project);
                grid.appendChild(card);
            });
        }

        function createProjectCard(name, project) {
            const createdDate = new Date(project.createdAt).toLocaleDateString('pt-BR');
            const hotspotCount = project.hotspots ? project.hotspots.length : 0;
            
            const card = document.createElement('div');
            card.className = 'project-card';
            card.innerHTML = `
                <div class="project-thumbnail">
                    <img src="${project.image}" alt="${project.title}">
                </div>
                <div class="project-info">
                    <div class="project-name">${project.title}</div>
                    <div class="project-meta">Tour Virtual 360¬∞ ‚Ä¢ ${createdDate} ‚Ä¢ ${hotspotCount} pontos</div>
                    <div class="project-actions">
                        <button class="btn-sm btn-view" onclick="previewProject('${name}')">üëÅÔ∏è Ver</button>
                        <button class="btn-sm btn-edit" onclick="editProject('${name}')">‚úèÔ∏è Editar</button>
                        <button class="btn-sm btn-delete" onclick="deleteProject('${name}')">üóëÔ∏è Excluir</button>
                    </div>
                </div>
            `;
            return card;
        }

        function previewProject(name) {
            const project = projects[name];
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('viewerContainer').classList.remove('hidden');
            document.getElementById('projectTitle').textContent = project.title;
            
            const projectLogo = document.getElementById('projectLogo');
            if (project.logo) {
                projectLogo.src = project.logo;
                projectLogo.style.display = 'block';
            } else {
                projectLogo.style.display = 'none';
            }
            
            // Atualizar URL para compartilhamento
            const shareUrl = window.location.origin + window.location.pathname + '?project=' + encodeURIComponent(name);
            window.history.pushState({}, '', shareUrl);
            
            if (viewer) viewer.destroy();
            viewer = pannellum.viewer('panorama', {
                type: 'equirectangular',
                panorama: project.image,
                autoLoad: true,
                hotSpots: project.hotspots.map(h => ({
                    id: h.id,
                    pitch: h.pitch,
                    yaw: h.yaw,
                    type: 'info',
                    text: h.text
                }))
            });
            isAdminViewing = true;
        }

        function editProject(name) {
            editingProjectName = name;
            const project = projects[name];
            document.getElementById('newProjectName').value = name;
            document.getElementById('newProjectTitle').value = project.title;
            hotspots = [...project.hotspots];
            
            if (project.logo) {
                const preview = document.getElementById('logoPreview');
                preview.innerHTML = `<img src="${project.logo}" alt="Logo preview" style="max-width:100px;">`;
                preview.classList.remove('hidden');
                document.getElementById('logoUploadText').innerHTML = '‚úÖ Logo carregada';
            }
            
            if (project.image) {
                showImagePreview(project.image);
            }
            
            document.getElementById('pageTitle').textContent = 'Editar Projeto';
            document.getElementById('submitProjectBtn').textContent = 'Salvar Altera√ß√µes';
            showSection('create');
        }

        function deleteProject(name) {
            if (confirm(`Excluir projeto "${projects[name].title}"?`)) {
                delete projects[name];
                saveProjects();
                updateProjectsGrid();
            }
        }

        function showSection(section) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById('projectsSection').classList.add('hidden');
            document.getElementById('createSection').classList.add('hidden');
            
            if (section === 'projects') {
                document.getElementById('projectsSection').classList.remove('hidden');
                document.getElementById('pageTitle').textContent = 'Projetos';
                document.getElementById('pageSubtitle').textContent = 'Aqui voc√™ faz a gest√£o de seus projetos.';
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                resetForm();
            } else if (section === 'create') {
                document.getElementById('createSection').classList.remove('hidden');
                if (!editingProjectName) {
                    document.getElementById('pageTitle').textContent = 'Criar Projeto';
                    document.getElementById('submitProjectBtn').textContent = 'Criar Projeto';
                }
                document.querySelectorAll('.nav-item')[1].classList.add('active');
            }
        }

        function resetForm() {
            editingProjectName = null;
            document.getElementById('createProjectForm').reset();
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('logoPreview').classList.add('hidden');
            document.getElementById('logoUploadText').innerHTML = 'üñºÔ∏è Clique para selecionar uma logo';
            hotspots = [];
            if (previewViewer) {
                previewViewer.destroy();
                previewViewer = null;
            }
        }

        function toggleNavigation() {
            if (isAdminViewing) {
                document.getElementById('viewerContainer').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                isAdminViewing = false;
                window.history.pushState({}, '', window.location.pathname);
            }
        }

        function logout() {
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('viewerContainer').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('adminForm').reset();
            document.getElementById('errorMessage').classList.add('hidden');
            window.history.pushState({}, '', window.location.pathname);
        }

        function shareProject() {
            // Gerar URL compartilh√°vel
            const projectName = new URLSearchParams(window.location.search).get('project') || 
                               Object.keys(projects).find(key => projects[key].title === document.getElementById('projectTitle').textContent);
            
            let shareUrl;
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // Desenvolvimento local
                shareUrl = `${window.location.origin}${window.location.pathname}?project=${encodeURIComponent(projectName)}`;
            } else {
                // Produ√ß√£o (Firebase ou outro host)
                shareUrl = `${window.location.origin}/?project=${encodeURIComponent(projectName)}`;
            }
            
            if (navigator.share) {
                navigator.share({
                    title: document.getElementById('projectTitle').textContent + ' - AMBI360',
                    text: 'Confira este tour virtual 360¬∞!',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('Link copiado! Compartilhe: ' + shareUrl);
                }).catch(() => {
                    prompt('Copie este link para compartilhar:', shareUrl);
                });
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeToggleBtn').textContent = isDark ? 'Modo Claro' : 'Modo Escuro';
        }

        function toggleFilterDropdown() {
            document.getElementById('filterDropdown').classList.toggle('hidden');
        }

        function sortProjects(type) {
            const projectEntries = Object.entries(projects);
            
            switch(type) {
                case 'newest':
                    projectEntries.sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt));
                    break;
                case 'oldest':
                    projectEntries.sort((a, b) => new Date(a[1].createdAt) - new Date(b[1].createdAt));
                    break;
                case 'alphabetical':
                    projectEntries.sort((a, b) => a[1].title.localeCompare(b[1].title));
                    break;
                case 'alphabetical-reverse':
                    projectEntries.sort((a, b) => b[1].title.localeCompare(a[1].title));
                    break;
            }
            
            const sortedProjects = {};
            projectEntries.forEach(([key, value]) => {
                sortedProjects[key] = value;
            });
            projects = sortedProjects;
            
            updateProjectsGrid();
            toggleFilterDropdown();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function showHelpModal() {
            document.getElementById('helpModal').classList.remove('hidden');
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.add('hidden');
        }

        function filterNavigation(searchTerm) {
            // Implementar filtro de navega√ß√£o se necess√°rio
        }

        function goBackToPreviousScene() {
            // Implementar navega√ß√£o entre cenas se necess√°rio
        }

        // Carregar tema salvo
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark');
            document.getElementById('themeToggleBtn').textContent = 'Modo Claro';
        }
    </script>
</body>
</html>