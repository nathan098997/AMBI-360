<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMBI360 - Teste de Compartilhamento</title>
    <link rel="stylesheet" href="frontend/style.css">
    <link rel="stylesheet" href="frontend/hotspots.css">
    <link rel="stylesheet" href="https://cdn.pannellum.org/2.5/pannellum.css">
</head>
<body>
    <!-- Viewer Container -->
    <section class="viewer-container" id="viewerContainer">
        <aside class="nav-sidebar" id="navSidebar">
            <div class="nav-header">
                <h2 id="navProjectTitle">Projeto</h2>
                <button class="nav-close" onclick="window.close()">‚úï</button>
            </div>
            <div class="nav-content">
                <div class="nav-section">
                    <h3>Ambientes</h3>
                    <div class="nav-rooms" id="navRooms"></div>
                </div>
            </div>
        </aside>
        
        <div class="viewer-main">
            <header class="viewer-header">
                <div class="viewer-title-container">
                    <img id="projectLogo" class="project-logo" src="" alt="Logo do Projeto" style="display: none;">
                    <div>
                        <h1 class="viewer-title" id="projectTitle"></h1>
                    </div>
                </div>
                <div class="viewer-controls">
                    <button class="control-btn" onclick="shareCurrentView()">üîó Compartilhar</button>
                    <button class="control-btn" onclick="toggleFullscreen()">‚õ∂ Tela Cheia</button>
                </div>
            </header>
            <div id="panorama"></div>
        </div>
    </section>

    <!-- Loading -->
    <div id="loading" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999;">
        <h2>Carregando projeto compartilhado...</h2>
    </div>

    <script src="https://cdn.pannellum.org/2.5/pannellum.js"></script>
    <script>
        let viewer = null;
        let currentProjectName = null;
        let projectHotspots = [];
        let currentScene = 'main';

        // Check for shared link on load
        document.addEventListener('DOMContentLoaded', function() {
            checkSharedLink();
        });

        function checkSharedLink() {
            const params = new URLSearchParams(window.location.search);
            const encodedData = params.get('share');
            
            if (!encodedData) {
                document.getElementById('loading').innerHTML = '<h2 style="color: red;">‚ùå Nenhum projeto compartilhado encontrado</h2>';
                return;
            }
            
            try {
                console.log('üîó Decodificando projeto compartilhado...');
                const shareData = JSON.parse(decodeURIComponent(atob(encodedData)));
                
                console.log('üì¶ Dados do projeto:', shareData);
                
                currentProjectName = shareData.id;
                projectHotspots = shareData.hotspots || [];
                
                document.getElementById('projectTitle').textContent = shareData.title;
                document.getElementById('navProjectTitle').textContent = shareData.title;
                
                if (shareData.logo) {
                    const projectLogo = document.getElementById('projectLogo');
                    projectLogo.src = shareData.logo;
                    projectLogo.style.display = 'block';
                }
                
                document.getElementById('loading').style.display = 'none';
                
                initializeViewer(shareData);
                
                if (shareData.point) {
                    setTimeout(() => {
                        if (viewer) {
                            viewer.loadScene('scene_' + shareData.point);
                        }
                    }, 1000);
                }
                
            } catch (e) {
                console.error('‚ùå Erro ao processar link:', e);
                document.getElementById('loading').innerHTML = '<h2 style="color: red;">‚ùå Erro ao carregar projeto compartilhado</h2>';
            }
        }

        function initializeViewer(project) {
            console.log('üé¨ Inicializando viewer...');
            
            if (projectHotspots.length > 0) {
                const scenes = createScenesConfig(project.image, projectHotspots);
                console.log('üé≠ Cenas criadas:', Object.keys(scenes));
                
                viewer = pannellum.viewer('panorama', {
                    default: {
                        firstScene: 'main',
                        autoLoad: true,
                        autoRotate: -2,
                        compass: true,
                        showZoomCtrl: true,
                        showFullscreenCtrl: true,
                        yaw: 0
                    },
                    scenes: scenes
                });
                
                viewer.on('scenechange', handleSceneChange);
            } else {
                console.log('üì∑ Viewer simples (sem hotspots)');
                viewer = pannellum.viewer('panorama', {
                    type: 'equirectangular',
                    panorama: project.image,
                    autoLoad: true,
                    autoRotate: -2,
                    compass: true,
                    showZoomCtrl: true,
                    showFullscreenCtrl: true,
                    yaw: 0
                });
            }
            
            viewer.on('load', updateNavigation);
        }

        function createScenesConfig(mainImage, hotspotsArray) {
            const scenes = { 
                main: { 
                    type: 'equirectangular', 
                    panorama: mainImage, 
                    hotSpots: [],
                    yaw: 0
                } 
            };
            
            const rootHotspots = (hotspotsArray || []).filter(h => h.parentId === null || h.parentId === undefined);
            
            rootHotspots.forEach(hotspot => {
                if (hotspot.targetImage) {
                    scenes.main.hotSpots.push({
                        id: hotspot.id,
                        pitch: hotspot.pitch,
                        yaw: hotspot.yaw,
                        type: 'scene',
                        text: hotspot.text,
                        sceneId: 'scene_' + hotspot.id,
                        cssClass: 'hotspot-nav'
                    });
                }
            });
            
            const allHotspots = (hotspotsArray || []);
            allHotspots.forEach((hotspot) => {
                if (hotspot.targetImage) {
                    const sceneId = 'scene_' + hotspot.id;
                    const hotSpots = [];
                    
                    const parentScene = hotspot.parentId ? 'scene_' + hotspot.parentId : 'main';
                    
                    hotSpots.push({
                        id: `back_${sceneId}`,
                        pitch: -10,
                        yaw: 180,
                        type: 'scene',
                        text: 'Voltar',
                        sceneId: parentScene,
                        cssClass: 'hotspot-back'
                    });
                    
                    const childHotspots = allHotspots.filter(child => child.parentId === hotspot.id);
                    childHotspots.forEach(child => {
                        if (child.targetImage) {
                            hotSpots.push({
                                id: child.id,
                                pitch: child.pitch,
                                yaw: child.yaw,
                                type: 'scene',
                                text: child.text,
                                sceneId: 'scene_' + child.id,
                                cssClass: 'hotspot-nav'
                            });
                        }
                    });
                    
                    scenes[sceneId] = {
                        type: 'equirectangular',
                        panorama: hotspot.targetImage,
                        hotSpots: hotSpots
                    };
                }
            });
            
            return scenes;
        }

        function handleSceneChange(sceneId) {
            currentScene = sceneId;
            updateNavigation();
        }

        function updateNavigation() {
            const navRooms = document.getElementById('navRooms');
            if (!navRooms) return;
            
            navRooms.innerHTML = '';
            
            const mainBtn = document.createElement('button');
            mainBtn.className = `nav-room ${currentScene === 'main' ? 'active' : ''}`;
            mainBtn.textContent = 'Cena Principal';
            mainBtn.onclick = () => {
                if (viewer && currentScene !== 'main') {
                    viewer.loadScene('main');
                }
            };
            navRooms.appendChild(mainBtn);
            
            const allHotspots = projectHotspots.filter(h => h.targetImage);
            
            allHotspots.forEach(hotspot => {
                const sceneId = 'scene_' + hotspot.id;
                const isCurrentScene = currentScene === sceneId;
                
                const btn = document.createElement('button');
                btn.className = `nav-room ${isCurrentScene ? 'active' : ''}`;
                btn.textContent = hotspot.text;
                btn.onclick = () => {
                    if (viewer && currentScene !== sceneId) {
                        viewer.loadScene(sceneId);
                    }
                };
                navRooms.appendChild(btn);
            });
        }

        function shareCurrentView() {
            alert('Sistema de compartilhamento funcionando! ‚úÖ');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
    </script>
</body>
</html>